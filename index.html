<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>PVQC éš¨èº«åˆ·é¡Œ (æ‰‹å‹•ç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 15px; text-align: center; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h1 { font-size: 1.4rem; color: #2c3e50; margin: 10px 0 15px 0; }
        textarea { width: 100%; height: 120px; border: 2px solid #eee; border-radius: 12px; padding: 12px; font-size: 14px; box-sizing: border-box; -webkit-appearance: none; }
        textarea:focus { border-color: #3498db; outline: none; }
        
        /* éŒ¯èª¤è¨Šæ¯å€ */
        .log-area { font-size: 0.85rem; color: #e74c3c; text-align: left; background: #fff5f5; padding: 8px; border-radius: 6px; margin-top: 10px; display: none; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
        .btn { padding: 16px; border: none; border-radius: 12px; font-size: 17px; font-weight: 600; cursor: pointer; color: white; transition: transform 0.1s; }
        .btn:active { transform: scale(0.97); }
        
        .btn-spell { background: linear-gradient(135deg, #ff7675, #d63031); }
        .btn-read { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .btn-listen { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); color: #444; }
        .btn-back { background: #636e72; margin-top: 30px; width: 100%; }

        .hidden { display: none !important; }
        
        .stat-bar { display: flex; justify-content: space-between; color: #636e72; font-size: 0.9rem; margin-bottom: 20px; font-weight: bold; }
        .question-box { min-height: 80px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; color: #2d3436; margin: 10px 0 20px; word-break: break-word; }
        
        input[type="text"] { width: 100%; padding: 15px; font-size: 20px; border: 2px solid #dfe6e9; border-radius: 10px; text-align: center; box-sizing: border-box; -webkit-appearance: none; }
        input[type="text"]:focus { border-color: #3498db; }

        .option-btn { background: #fff; border: 2px solid #f1f2f6; width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px; font-size: 1.1rem; color: #2d3436; text-align: left; font-weight: 500; }
        .option-btn:active { background: #f1f2f6; }
        .option-btn.correct { background: #00b894; color: white; border-color: #00b894; }
        .option-btn.wrong { background: #ff7675; color: white; border-color: #ff7675; }
    </style>
</head>
<body>

<div class="container" id="setup-screen">
    <h1>PVQC åˆ·é¡Œ (ç„¡å­˜æª”ç‰ˆ)</h1>
    <textarea id="vocab-input" placeholder="è«‹è²¼ä¸Šé€™è¼ªè¦ç·´çš„å–®å­—..."></textarea>
    
    <div id="parse-log" class="log-area"></div>

    <div class="btn-group">
        <button class="btn btn-spell" onclick="startMode('spell')">ğŸ“ æ‹¼å¯«ç‰¹è¨“</button>
        <button class="btn btn-read" onclick="startMode('read_choice')">ğŸ“„ é–±è®€é¸ä¸­</button>
        <button class="btn btn-listen" onclick="startMode('listen_choice')">ğŸ§ è½åŠ›é¸ä¸­</button>
    </div>
</div>

<div class="container hidden" id="game-screen">
    <div class="stat-bar">
        <span id="mode-badge">è¨“ç·´æ¨¡å¼</span>
        <span>å‰©é¤˜: <span id="q-left">0</span></span>
    </div>

    <div id="q-display" class="question-box"></div>

    <div id="area-spell" class="hidden">
        <input type="text" id="ans-input" placeholder="è¼¸å…¥è‹±æ–‡..." autocomplete="off" spellcheck="false" autocapitalize="off">
        <div id="spell-feedback" style="height:30px; margin-top:10px; font-weight:bold;"></div>
        <button class="btn" style="background:#2d3436; margin-top:15px;" onclick="checkSpell()">é€å‡º (Enter)</button>
    </div>

    <div id="area-choice" class="hidden"></div>

    <button class="btn btn-back" onclick="goBack()">è¿”å› / æ›ä¸€çµ„å–®å­—</button>
</div>

<script>
    let vocabList = [];
    let pool = [];
    let current = null;
    let mode = '';
    let isLocked = false;
    let synth = window.speechSynthesis;

    function parseVocab() {
        const raw = document.getElementById('vocab-input').value.trim();
        const logArea = document.getElementById('parse-log');
        logArea.style.display = 'none';
        logArea.innerHTML = '';

        if(!raw) return alert("è«‹å…ˆè²¼ä¸Šå–®å­—ï¼");

        let lines = raw.split('\n').map(l => l.trim()).filter(l => l);
        let parsed = [];
        let errorLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            let hasZh = /[^\x00-\x7F]/.test(line);
            let hasEn = /[a-zA-Z]/.test(line);

            // 1. åŒè¡Œæœ‰ä¸­è‹±æ–‡
            if (hasZh && hasEn) {
                let match = line.match(/[^\x00-\x7F]/);
                let splitIdx = match ? match.index : -1;
                if (splitIdx > 0) {
                    parsed.push({ en: line.slice(0, splitIdx).trim().replace(/,$/, ''), zh: line.slice(splitIdx).trim() });
                    continue;
                }
            }
            // 2. åˆ†è¡Œæ ¼å¼ (ä¸Šè‹±ä¸‹ä¸­)
            if (i + 1 < lines.length) {
                let next = lines[i+1];
                let nextZh = /[^\x00-\x7F]/.test(next);
                if (hasEn && !hasZh && nextZh) {
                    parsed.push({ en: line, zh: next });
                    i++;
                    continue;
                }
            }
            // 3. æŠ“ä¸åˆ°çš„åˆ—å…¥éŒ¯èª¤ç´€éŒ„
            errorLines.push(`ç¬¬ ${i+1} è¡Œç„¡æ³•è­˜åˆ¥: ${line.substring(0, 10)}...`);
        }
        
        vocabList = parsed;

        if (errorLines.length > 0) {
            logArea.style.display = 'block';
            logArea.innerHTML = `<strong>âš ï¸ æˆåŠŸ ${parsed.length} å€‹ï¼Œä½†ç•¥é ${errorLines.length} è¡Œï¼š</strong><br>` + errorLines.slice(0, 2).join('<br>') + (errorLines.length > 2 ? '<br>...' : '');
            // å¦‚æœæˆåŠŸæ•¸é‡æ˜¯ 0ï¼Œå‰‡å ±éŒ¯é˜»æ­¢é–‹å§‹
            if (parsed.length === 0) {
                alert("å®Œå…¨è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼");
                return false;
            }
        } else if (parsed.length === 0) {
            alert("è®€å–å¤±æ•—"); 
            return false; 
        }

        return true;
    }

    function startMode(m) {
        if(!parseVocab()) return;
        mode = m;
        pool = [...vocabList]; 
        shuffle(pool);

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        const titles = { 'spell': 'æ‹¼å¯«ç‰¹è¨“', 'read_choice': 'é–±è®€é¸ä¸­', 'listen_choice': 'è½åŠ›é¸ä¸­' };
        document.getElementById('mode-badge').innerText = titles[mode];
        nextQuestion();
    }

    function nextQuestion() {
        isLocked = false;
        if(pool.length === 0) {
            alert("ğŸ‰ é€™çµ„ç·´å®Œå›‰ï¼");
            return goBack();
        }

        current = pool.pop();
        document.getElementById('q-left').innerText = pool.length + 1;
        
        const display = document.getElementById('q-display');
        const areaSpell = document.getElementById('area-spell');
        const areaChoice = document.getElementById('area-choice');
        
        areaSpell.classList.add('hidden');
        areaChoice.classList.add('hidden');
        document.getElementById('spell-feedback').innerHTML = '';
        document.getElementById('ans-input').value = '';

        if(mode === 'spell') {
            display.innerText = current.zh;
            areaSpell.classList.remove('hidden');
            setTimeout(()=>document.getElementById('ans-input').focus(), 100);
        } else if(mode === 'read_choice') {
            display.innerText = current.en;
            areaChoice.classList.remove('hidden');
            renderChoices();
        } else if(mode === 'listen_choice') {
            display.innerHTML = '<span style="font-size:3rem; cursor:pointer;" onclick="speak()">ğŸ”Š</span>';
            areaChoice.classList.remove('hidden');
            renderChoices();
            setTimeout(speak, 300);
        }
    }

    function checkSpell() {
        if(isLocked) return;
        const val = document.getElementById('ans-input').value.trim();
        const fb = document.getElementById('spell-feedback');

        if(val.toLowerCase() === current.en.toLowerCase()) {
            isLocked = true;
            fb.innerHTML = '<span style="color:#00b894">âœ… Correct!</span>';
            speak();
            setTimeout(nextQuestion, 600);
        } else {
            fb.innerHTML = `<span style="color:#ff7675">âŒ</span> <span style="font-size:0.8rem; text-decoration:underline; cursor:pointer;" onclick="alert('${current.en}')">å·çœ‹ç­”æ¡ˆ</span>`;
            speak();
            document.getElementById('ans-input').select();
        }
    }

    function renderChoices() {
        const div = document.getElementById('area-choice');
        div.innerHTML = '';
        
        // å¦‚æœå–®å­—é‡å¤ªå°‘ï¼Œå°±ä¸åšæ··æ·†é …éæ¿¾ï¼Œé¿å…æ­»æ©Ÿ
        let distractors = vocabList.filter(v => v.en !== current.en);
        if (distractors.length === 0) distractors = [...vocabList]; // fallback

        shuffle(distractors);
        let options = distractors.slice(0, 3);
        options.push(current);
        shuffle(options);
        
        // è£œæ»¿é¸é … (è¬ä¸€å–®å­—çœŸçš„å¾ˆå°‘)
        while(options.length < 4 && vocabList.length >= 4) options.push(distractors[0]);

        options.forEach(opt => {
            let btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt.zh; 
            btn.onclick = () => {
                if(isLocked) return;
                if(opt.en === current.en) {
                    isLocked = true;
                    btn.classList.add('correct');
                    if(mode==='listen_choice') speak();
                    setTimeout(nextQuestion, 400);
                } else {
                    btn.classList.add('wrong');
                    btn.style.opacity = '0.6';
                    if(mode==='listen_choice') speak();
                }
            };
            div.appendChild(btn);
        });
    }

    function speak() {
        if(!current) return;
        let txt = current.en.replace(/\(.*\)/, '');
        let u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-US'; 
        synth.speak(u);
    }

    function shuffle(arr) {
        for(let i=arr.length-1; i>0; i--) {
            let j = Math.floor(Math.random()*(i+1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }

    function goBack() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
        // ä¸æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…æª¢æŸ¥æˆ–ç¹¼çºŒè²¼ä¸‹ä¸€çµ„
    }

    document.getElementById('ans-input').addEventListener('keypress', (e)=>{
        if(e.key === 'Enter') checkSpell();
    });
</script>
</body>
</html>
